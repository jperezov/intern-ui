/**!
 * intern-ui v0.0.3
 * Copyright (c) 2016 Jonathan Perez.
 * Released under the MIT license
 */

(function(){"use strict";var app=angular.module("AutomatedTests",["ngRoute"]),URL={TEMPLATE:{SITE:"assets/templates/site.html",TEST_SUITE:"assets/templates/testSuite.html"},VIEW:{HIDDEN:"assets/views/hidden.html",MODAL:{UNIT:"assets/views/modal/unit.html",FUNCTIONAL:"assets/views/modal/functional.html"}},GET:{CONFIG:"config.json",TEST_MODULES:"getTests.js",FUNCTIONAL_TEST:"runner.js"},RUN:{UNIT:function(site,suite){return"#/unit/"+site+"/"+suite},FUNCTIONAL:function(site,functionalTest){return"#/functional/"+site+"/"+functionalTest}}};app.factory("getTests",["$http",function($http){return $http({method:"GET",url:URL.GET.TEST_MODULES,cache:!0}).then(function(resp){var inputTest,functionalTests,unitTests,tests=resp.data,output=[];for(var test in tests.sites)(function(site){inputTest={name:site.replace(/([a-z])([A-Z])/g,"$1 $2"),tests:[]},tests[site].functional&&(functionalTests=tests[site].functional.slice(1).map(function(val){return val.url=URL.RUN.FUNCTIONAL(site,val.name.replace(/\//g,"~@~")),val}),inputTest.tests.push({name:site,type:"functional",description:"Run these to simulate a real user.",browser:0,run:{all:{name:"All Tests",url:URL.RUN.FUNCTIONAL(site,"all"),num:tests[site].functional[0].num},tests:functionalTests}})),tests[site].unit&&(unitTests=tests[site].unit.slice(1).map(function(val){return val.url=URL.RUN.UNIT(site,val.name.replace(/\//g,"~@~")),val}),inputTest.tests.push({name:site,type:"unit",description:"Run these to ensure the code works as intended.",run:{all:{name:"All Tests",url:URL.RUN.UNIT(site,"all"),num:tests[site].unit[0].num},tests:unitTests}})),output.push(inputTest)})(tests.sites[test]);return output},function(err){return err})}]),app.controller("MainCtrl",["$scope","getTests","$location",function($scope,getTests,$location){$scope.$on("$locationChangeSuccess",function(){$scope.hideScroll=!!$location.path().toString().match(/\/unit/)}),getTests.then(function(tests){$scope.tests=tests})}]),app.controller("UnitCtrl",["$scope","$routeParams",function($scope,$routeParams){$scope.site=$routeParams.site,$scope.suite=$routeParams.suite,$scope.url="/node_modules/intern/client.html?config=tests/intern&suites=tests/unit/"+$routeParams.site+"/"+$routeParams.suite.replace(/~@~/g,"/")}]);var isNaN=window.isNaN;app.factory("runFunctionalTests",["$http",function($http){return function(site,functionalTest,browser){return $http({method:"GET",url:URL.GET.FUNCTIONAL_TEST,params:{site:site,functionalTest:functionalTest,browser:browser},cache:!0}).then(function(resp){return resp.data.replace(/Globals\sset/g,"").replace(/Initializing\stest\s\d/g,"").replace(/.*Running\s".*/g,"").replace(/\s*\bat\b.*/g,"").replace(/.>>\s./g,"").split(/\n/).filter(function(n){return n}).map(function(val){var pass=!1,fail=!1;if(isNaN(val.trim()[0])===!1){var numerator=+val.trim().match(/\d*\b/)[0];fail=numerator!==0}else pass=!!val.match(/\bpass\b/i),fail=!!val.match(/\b(fail|error)\b/i);return{pass:pass,fail:fail,message:val}})},function(err){return err})}}]),app.controller("FunctionalCtrl",["$scope","$routeParams","runFunctionalTests",function($scope,$routeParams,runFunctionalTests){$scope.site=$routeParams.site,$scope.browser=$routeParams.browser,runFunctionalTests($routeParams.site,$routeParams.functionalTest.replace(/~@~/g,"/"),$routeParams.browser).then(function(results){$scope.results=results})}]),app.directive("site",function(){return{restrict:"E",scope:{data:"="},templateUrl:URL.TEMPLATE.SITE}}),app.directive("testSuite",function(){return{restrict:"E",scope:{data:"="},templateUrl:URL.TEMPLATE.TEST_SUITE}}),app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:URL.VIEW.HIDDEN}).when("/unit/:site/:suite",{controller:"UnitCtrl",templateUrl:URL.VIEW.MODAL.UNIT}).when("/functional/:site/:functionalTest/:browser",{controller:"FunctionalCtrl",templateUrl:URL.VIEW.MODAL.FUNCTIONAL}).otherwise({redirectTo:"/"})})})();